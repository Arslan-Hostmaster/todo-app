---
- hosts: swarm-node-ecr
  become: true

  tasks:
  - name: login to registry
    command: aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 878919740555.dkr.ecr.us-east-1.amazonaws.com

  - name: create docker image using war file
    command: docker build -t todoapp .
    args:
      chdir: /home/ec2-user/docker/todoapp

  - name: verify that the image was created correctly.
    command: docker images --filter reference=todoapp

  - name: create tag to image
    command: docker tag todoapp:latest 878919740555.dkr.ecr.us-east-1.amazonaws.com/todoapp:latest

  - name: push image on to dockerhub
    command: docker push 878919740555.dkr.ecr.us-east-1.amazonaws.com/todoapp:latest

  - name: remove docker images form ansible server
    command: docker rmi todoapp:latest 878919740555.dkr.ecr.us-east-1.amazonaws.com/todoapp:latest
    ignore_errors: yes
